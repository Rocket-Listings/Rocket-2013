{% load static from staticfiles %}
<h3>
  <span class="listing-title">{{ listing.title|default:"Create a Listing" }}</span>
  <small id="loading" class="text-muted" style="display: none;">Saving...</small>
</h3>
{# {{ formset.as_p }} #}

{# {% for hidden in formset.hidden_fields %} #}
  {# {{ hidden }} #}
{# {% endfor %} #}

<form class="listing-form">
  <input type="hidden" name="category" id="id_category" value="{{ listing.category_id|default:"" }}"/>
  {# Category Select #}
  <fieldset id="category-fieldset">
    <legend>Category</legend>
    {% comment %}
    {% for error in form.category.errors %}
    <div class="alert alert-danger">
      <p>{{ error }}</p>
    </div>
    {% endfor %}
    {% endcomment %}
    <ul class="nav nav-tabs">
      <li class="active">
        <a href="#forsale" data-toggle="tab">For Sale</a>
      </li>
      <li>
        <a href="#housing" data-toggle="tab">Housing</a>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane cat-pane active" id="forsale">
        <div class="row">
          <div class="col-lg-2 col-sm-4 col-3">
          {% for cat in cats.forsale %}
              <a class="cat" data-id="{{ cat.id }}">{{ cat.name }}</a>
              {# next column #}
              {% if forloop.counter|divisibleby:6 %}</div><div class="col-lg-2 col-sm-4 col-3">{% endif %}
          {% endfor %}
          </div>
        </div>
      </div>
      <div class="tab-pane cat-pane" id="housing">
        <div class="row">
          <div class="col-lg-2 col-sm-4 col-3">
          Coming soon!
          {% comment %}
          {% for cat in cats.housing %}
              <a class="cat" data-id="{{ cat.id }}">{{ cat.name }}</a>
              {# next column #}
              {% if forloop.counter|divisibleby:3 %}</div><div class="col-lg-3 col-sm-4 col-3">{% endif %}
          {% endfor %}
          {% endcomment %}
          </div>
        </div>
      </div>
    </div>
  </fieldset>

  {# First form row #}
  <fieldset id="info-fieldset">
    <legend>Listing Info</legend>
    {# Title #}
    <div class="row">
      <div class="col-sm-9 form-group{# {% if form.title.errors %} has-error {% endif %} #}">
        
        <label for="id_title">Title:</label>
        <input id="id_title" class="title form-control" maxlength="200" name="title" type="text" placeholder="" value="{{ listing.title|default:"" }}">
        {% comment %}
        {% for error in form.title.errors %}
          <span class="help-block">{{ error }}</span>
        {% endfor %}
        {% endcomment %}
      </div>
      <div class="col-sm-3 form-group{# {% if form.price.errors %} has-error {% endif %} #}">
        <label for="id_price">Price</label>
        <div class="input-group">
          <span class="input-group-addon">$</span>
          <input id="id_price" class="price form-control" name="price" type="text" placeholder="" value="{{ listing.price|default:"" }}">
        </div>
        {# {% for error in form.price.errors %}<span class="help-block">{{ error }}</span>{% endfor %} #}
      </div>
    </div>
  </fieldset>
  <fieldset id="spec-fieldset">
    <legend>Information</legend>

    {# json of initial specs #}
    <script type="text/json" id="initial-specs">
      {% include "listings/partials/initial_specs.json" %}
    </script>

    {# template for spec form #}
    {% verbatim %}
    <script id="spec-edit-template" type="text/template">
      {{#specs}}
      <div class="form-group col-lg-3">
        <label for="id_spec-{{index}}">{{ name }}</label>
        <input class="form-control" id="id_spec-{{index}}" maxlength="100" type="text" value="{{ value }}" />
      </div>
      {{/specs}}  
    </script>
    {% endverbatim %}

    {% for spec in specs %}
    <input type="hidden" class="spec-data" data-id="{{ spec.id }}" name="{{ spec.name }}" value="{{ spec.value }}" />
    {% endfor %}
    </div>

    <div id="spec-row" class="row">
      {% comment %}
      {% for form in spec_formset %}
      <div class="form-group col-lg-3">
        <input id="{{form.name.id}}" maxlength="100" name="{{form.name.name}}" type="hidden" value="{{ form.instance.name }}" />
        <label for="id_spec_set-{{form.id.value}}-value">{{ name }}</label>
        <input class="form-control" id="id_spec_set-{{form.id.value}}-value" maxlength="100" name="spec_set-{{index}}-value" type="text" value="{{ value }}" />
        <input id="id_spec_set-{{form.id.value}}-DELETE" name="spec_set-{{form.id.value}}-DELETE" type="hidden" />
      </div>
      {% endfor %} 
      {% endcomment %}
    </div>

    {# description #}
    <div class="form-group{# {% if form.description.errors %} has-error {% endif %} #}">
      <label for="id_description">Description</label>
      <textarea id="id_description" class="description form-control" placeholder="" name="description" rows="5">{{ listing.description|default:"" }}</textarea>
    {# {% for error in form.price.errors %}<span class="help-block">{{ error }}</span>{% endfor %} #}
   </div>
  </fieldset>
  <fieldset id="marketplace-location-fieldset"><legend>Marketplace &amp; Location</legend>
    <div class="row">
      <div id="market-col" class="col-lg-6">
        <label for="id_market" class="control-label">Market</label>
          <input type = "hidden" class= "form-select" name = "market" style="display:none" value = "{{form.market.value|default:""}}">
          </input> 
          <input type = "hidden" class= "form-select-sub" name = "sub_market" style="display:none" value = "{{form.sub_market.value|default:""}}">
          </input>
          <input type = "hidden" class= "form-select-hood" name = "hood" style="display:none" value = "{{form.hood.value|default:""}}">
          </input>
      </div>
      <div class="col-lg-6">
        <div class="form-group{# {% if form.location.errors %} has-error {% endif %}#}">
          <label for="id_location">Precise Location<span class="text-muted">(Be as specific as you want)</span></label>
          <input type="text" placeholder="" class="location form-control" id="id_location" maxlength="200" name="location" value="{{ listing.location|default:"" }}">
        </div>
        {# <label class="form-label">Map</label> #}
      </div>
    </div>
    <div class="location-map-wrapper">
      <div id="location-map"></div>
      <button id="location-btn" class="btn btn-default" type="button">Guess Current Location <i class="glyphicon glyphicon-screenshot"></i></button>
      <img src="{% static 'users/img/100px_loading.gif' %}" class="loading-spinner"/>
    </div>
  </fieldset>
  <fieldset id="photo-fieldset">
    <legend>Photo Upload<small class="photo-view text-muted">Drag to reorder</small>
      <a class="btn btn-small btn-default pull-right photo-view toggle-view">Upload more</a>
      <a class="btn btn-small btn-default pull-right upload-view toggle-view" style="display: none;">Arrange photos</a>      
    </legend>

    {# errors #}
    {% comment %}
    {% for dict in photo_formset.errors %}
    {% for error in dict.values %}
      <div class="alert alert-warning alert-block">
      {{ error }}
      </div>  
    {% endfor %}
    {% endfor %}
    {% endcomment %}

    {# filepicker iframe #}
    <iframe class="upload-view" id="fp-container"></iframe>

    {# thumbnails #}
    <div id="photos" class="row sortable photo-view">
      {% comment %}
      {% for form in photo_formset %}
      <div class="col-lg-2" data-id="{{ forloop.counter0 }}" draggable="true">
        <img src="{{ S3_URL }}" class="img-responsive">
        {{ form }}
      </div>
      {% endfor %}
      {% endcomment %}
    </div>

    {# hidden formset #}
    {% comment %}
    <div id="photo-formset" class="hide">
      {{ photo_formset }}    
    </div>
    {% endcomment %}

    <iframe class="upload-view" id="fp-container"></iframe>
    {# Mustache Template #}
    {% verbatim %}
    <script id="photo-thumbnail-template" type="text/template">
      {{#photos}}
      <div class="col-lg-2" data-id="{{ index }}" draggable="true">
        <img src="{{ src }}" class="img-responsive">
      </div>
      {{/photos}}
    </script>
    {% endverbatim %}
      {# <input id="id_listingphoto_set-{{num}}-id" name="listingphoto_set-{{num}}-id" type="hidden" /> #}
  </fieldset>

  <div class="btn-toolbar pull-right">
    {# <input id="submit-draft" type="submit" class="btn btn-primary" name="listing_action" value="Save as Draft"/> #}
    <a class="publish-btn btn btn-success">Publish to Craigslist</a>
  </div>
</form>
<script id="market-data" type="text/json">
  {% include 'listings/partials/markets.json' %}
</script>
