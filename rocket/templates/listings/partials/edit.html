{% load specval %}
<h2>{{ form.title.value|default:"Create a Listing" }}</h2>
{# {{ formset.as_p }} #}

{% for hidden in formset.hidden_fields %}
  {{ hidden }}
{% endfor %}
{% comment %}
{% for form in formset %}
{% for field in form %}
  {{ field }}
{% endfor %}
{% endfor %}
{% endcomment %}
<form method="POST" class="listing-form form-horizontal">
  {% csrf_token %}
  {# Hidden fields  #}
  {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
  <input type="hidden" id="id_location" maxlength="200" name="location" value="Bethesda, MD">

  {% comment %}
  {# Errors at the top #}
  {% for field, errors in form.errors.items %}
    <div class="alert alert-error alert-block">
      <button type="button" class="close" data-dismiss="alert">&times;</button>
      <h4>Oops, a few errors</h4>
      <ul class="errors">
        {% for error in errors %}
          <li><strong>{{ field }}</strong>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endfor %}
  {% comment %}

  {% comment %}
  {% for group, cat_list in cats.items %}
  <h2>{{ group }}</h2>
  <ul>
  {% for cat in cat_list %}
  <li>{{ cat }}</li>
  {% endfor %}
  </ul>
  {% endfor %}
  {% endcomment %}
  {# Category Select #}
  <fieldset><legend>Category{% if form.category.errors %}<p class="text-error">{{ form.category.errors }}</p>{% endif %}</legend>
    <ul class="nav nav-tabs">
      <li class="active">
        <a href="#forsale" data-toggle="tab">For Sale</a>
      </li>
      <li>
        <a href="#housing" data-toggle="tab">Housing</a>
      </li>
    </ul>
    <div class="tab-content">
      {% for group, cat_list in cats.items %}
      <div class="tab-pane{% if group == "forsale" %} active{% endif %}" id="{{ group }}">
        <div class="row">
          <div class="col-lg-2">
          {% for cat in cat_list %}
              <a class="cat {{ group }}" data-id="{{ cat.id }}">{{ cat.name }}</a>
            {% if group == "forsale" and forloop.counter|divisibleby:9 or group == "housing" and forloop.counter|divisibleby:3 %}
              </div><div class="col-lg-2">
            {% endif %}
          {% endfor %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </fieldset>

  {# First form row #}
  <fieldset><legend>Listing Info</legend>
  <div class="row">
      {# Title #}
      <div class="col-lg-6">
        <div class="row">
          <div class="col-lg-4">
            <label>{{ form.title.label }}</label>
            <input class="title input-block-level" maxlength="200" name="title" type="text" placeholder="e.g. 2000 Jeep Wrangler 4.0L" value="{{ form.title.value|default:"" }}">
          </div>
          <div class="col-lg-2">
            <label>{{ form.price.label }}</label>
            <div class="input-prepend gridfix">
              <span class="add-on">$</span>
              <input class="price input-block-level" name="price" type="text" value="{{ form.price.value|default:"" }}">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-6">
            <label>{{ form.description.label }}</label>
            <textarea class="col-lg-6 description" placeholder="Describe your item" cols="40" name="description" rows="10">{{ form.description.value|default:"" }}</textarea>
          </div>
        </div>
      </div>
      <div class="col-lg-3">
        <label>Location</label>
        <img src="http://placehold.it/370x390"/>
      </div>
    </div>
  </fieldset>
  <fieldset id="spec-fieldset" class="hide"><legend>Specifications</legend>
    <div class="specs-form">
        {% for spec_key in spec_keys %}
        <div class="control-group hide" data-cat="{{ spec_key.category_id }}">
            <label class="control-label" for="spec-{{ spec_key.id }}">{{ spec_key.name }}</label>
            <div class="controls">
              <input type="text" disabled="disabled" name="spec-{{ spec_key.id }}" value="{{ specs|specval:spec_key.id }}"/>
            </div>
        </div>
        {% endfor %}
    </div>
  </fieldset>
  <fieldset>
    <legend>Photo Upload<small class="photo-view">Drag to reorder</small>
      <a class="btn pull-right hide photo-view toggle-view">Upload more</a>
      <a class="btn pull-right hide upload-view toggle-view">Arrange photos</a>      
    </legend>
    <ul id="photos" class="thumbnails sortable photo-view"></ul>
    <iframe class="upload-view" id="fp-container"></iframe>
    
    <input id="id_listingphoto_set-TOTAL_FORMS" name="listingphoto_set-TOTAL_FORMS" type="hidden" />
    <input id="id_listingphoto_set-INITIAL_FORMS" name="listingphoto_set-INITIAL_FORMS" type="hidden" value="0" />
    <input id="id_listingphoto_set-MAX_NUM_FORMS" name="listingphoto_set-MAX_NUM_FORMS" type="hidden" value="1000" />    

    {% verbatim %}
    <script id="thumbnail-template" type="text/template">
      {{#imgs}}
      <li class="col-lg-2" draggable="true">
        <div class="thumbnail" draggable="true">
          <img src="{{ src }}" draggable="true">
        </div>

        <input class="listingphoto_set-key" id="id_listingphoto_set-{{ index }}-key" name="listingphoto_set-{{ index }}-key" type="hidden" value="{{ key }}"/>
        <input class="listingphoto_set-url" id="id_listingphoto_set-{{ index }}-url" name="listingphoto_set-{{ index }}-url" type="hidden" value="{{ url }}"/>        
        <input class="listingphoto_set-order" id="id_listingphoto_set-{{ index }}-order" name="listingphoto_set-{{ index }}-order" type="hidden" value="{{ index }}"/>
        <input class="listingphoto_set-delete hide" id="id_listingphoto_set-{{ index }}-DELETE" name="listingphoto_set-{{ index }}-DELETE" type="checkbox" />
        <input class="listingphoto_set-listing" id="id_listingphoto_set-{{ index }}-listing" name="listingphoto_set-{{ index }}-listing" type="hidden"{% endverbatim %}{% if form.instance %} value="{{ form.instance.id }}" {% endif %}{% verbatim %}/>
        <input class="listingphoto_set-id" id="id_listingphoto_set-{{ index }}-id" name="listingphoto_set-{{ index }}-id" type="hidden" />
      </li>
      {{/imgs}}
    </script>
    {% endverbatim %}
  </fieldset>
  <div class="form-actions">
    <button type="submit" class="btn btn-primary">Post to Craigslist</button>
  </div>
</form>